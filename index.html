<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Job CSV → Poster JSON Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-slate-100 min-h-screen">

  <div class="max-w-7xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Job CSV → Poster JSON Generator</h1>

    <!-- Controls -->
    <div class="bg-white rounded-xl shadow p-4 grid md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">Upload CSV</label>
        <input type="file" id="csvFile" accept=".csv" class="block w-full text-sm" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Google Sheets CSV Link</label>
        <input type="text" id="sheetLink" placeholder="Paste Google Sheets CSV link"
               class="w-full border rounded-lg p-2 text-sm" />
      </div>

      <div class="flex items-end gap-2">
        <button id="loadSheet"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
          Load Sheet
        </button>
        <span id="statusMsg" class="text-sm text-green-600 hidden">Loaded ✓</span>
      </div>
    </div>

    <!-- Cards -->
    <div id="cards" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-6"></div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white max-w-2xl w-full rounded-xl shadow-lg p-4">
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Prompt Preview</h2>
        <button id="closeModal" class="text-gray-500 hover:text-black">✕</button>
      </div>
      <pre id="modalContent" class="bg-slate-100 p-3 rounded text-xs overflow-auto max-h-[60vh]"></pre>
    </div>
  </div>

<script>
const cardsEl = document.getElementById("cards");
const csvFileInput = document.getElementById("csvFile");
const sheetLinkInput = document.getElementById("sheetLink");
const loadSheetBtn = document.getElementById("loadSheet");
const statusMsg = document.getElementById("statusMsg");

const modal = document.getElementById("modal");
const modalContent = document.getElementById("modalContent");
const closeModal = document.getElementById("closeModal");

// Remember sheet link
const savedLink = localStorage.getItem("sheetLink");
if (savedLink) {
  sheetLinkInput.value = savedLink;
}

// Helpers
function parseCSV(text) {
  const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
  return rows.map(row => {
    const result = [];
    let current = "";
    let inQuotes = false;

    for (let i = 0; i < row.length; i++) {
      const char = row[i];
      if (char === '"' && row[i + 1] === '"') {
        current += '"';
        i++;
      } else if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === "," && !inQuotes) {
        result.push(current);
        current = "";
      } else {
        current += char;
      }
    }
    result.push(current);
    return result.map(c => c.trim());
  });
}

function buildJSON(job) {
  return {
    "poster_type": "Job Recruitment Poster",
    "aspect_ratio": "1:1",
    "Resolution": "1080 x 1080",
    "design_style": {
      "theme_colors": ["blue", "white"],
      "look_and_feel": "Professional, modern, clean, Canva/Photoshop-style",
      "typography": "Sans-serif, corporate, readable hierarchy",
      "background": {
        "image_source": "Create a best background matching poster_type JD Designation_Name",
        "effect": "Blurred",
        "overlay": "Soft white/blue gradient for text readability"
      }
    },
    "job_details": {
      "Job_ID": job.Job_ID,                // keep as-is
      "JD": job.JD,                        // keep as-is
      "Designation_Name": job.Designation, // keep as-is
      "Experience": job.Experience         // keep as-is
    },
    "layout_structure": {
      "top_section": "Job title highlighted with bold typography",
      "middle_section": "Job details displayed in a clean card or grid format",
      "bottom_section": "Contact details aligned neatly with icons"
    },
    "footer_details": {
      "Website": "https://www.itjobcell.com/",
      "Email": "careers@itjobcell.com",
      "Phone": "+91 9526011800"
    },
    "visual_elements": {
      "icons": ["website", "email", "phone"],
      "shapes": "Soft rounded rectangles or lines",
      "spacing": "Balanced white space for premium appearance"
    },
    "constraints": {
      "no_repeated_information": true,
      "single_occurrence_of_contact_details": true
    }
  };
}

function renderCards(data) {
  cardsEl.innerHTML = "";

  data.forEach(job => {
    const json = buildJSON(job);

    const card = document.createElement("div");
    card.className = "bg-white rounded-xl shadow p-4 flex flex-col gap-2";

    card.innerHTML = `
      <div class="font-semibold text-lg">${job.Designation || "No Designation"}</div>
      <div class="text-sm text-gray-600">Job ID: ${job.Job_ID}</div>
      <div class="text-sm">Experience: ${job.Experience}</div>
      <div class="text-xs text-gray-500 line-clamp-2">${job.JD}</div>

      <div class="mt-3 flex gap-2">
        <button class="previewBtn bg-slate-200 px-3 py-1 rounded text-sm hover:bg-slate-300">
          Prompt Preview
        </button>
        <button class="copyBtn bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
          Copy JSON
        </button>
        <span class="copyMsg text-green-600 text-sm hidden">Copied ✓</span>
      </div>
    `;

    const previewBtn = card.querySelector(".previewBtn");
    const copyBtn = card.querySelector(".copyBtn");
    const copyMsg = card.querySelector(".copyMsg");

    previewBtn.onclick = () => {
      modalContent.textContent = JSON.stringify(json, null, 2);
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    };

    copyBtn.onclick = async () => {
      await navigator.clipboard.writeText(JSON.stringify(json, null, 2));
      copyMsg.classList.remove("hidden");
      setTimeout(() => copyMsg.classList.add("hidden"), 1500);
    };

    cardsEl.appendChild(card);
  });
}

closeModal.onclick = () => {
  modal.classList.add("hidden");
  modal.classList.remove("flex");
};

// Main processing
function processCSVText(text) {
  const rows = parseCSV(text);
  if (rows.length < 2) return;

  const headers = rows[0].map(h => h.trim());
  const idx = (name) => headers.findIndex(h => h.toLowerCase() === name.toLowerCase());

  const iJobID = idx("Job ID");
  const iJD = idx("JD");
  const iDesig = idx("Designation Name");
  const iExp = idx("Experience if required");
  const iStatus = idx("status");

  const jobs = [];

  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];

    const jobID = (row[iJobID] || "").trim();
    const jd = (row[iJD] || "").trim();
    const desig = (row[iDesig] || "").trim();
    const exp = (row[iExp] || "").trim();
    const status = ((row[iStatus] || "").trim().toLowerCase());

    // Exclusion rules
    if (status === "posted") continue;
    if (!jobID) continue;
    if (!exp) continue;

    jobs.push({
      Job_ID: jobID,
      JD: jd,
      Designation: desig,
      Experience: exp
    });
  }

  renderCards(jobs);
}

// File upload
csvFileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    processCSVText(reader.result);
  };
  reader.readAsText(file);
});

// Load sheet
loadSheetBtn.addEventListener("click", async () => {
  const link = sheetLinkInput.value.trim();
  if (!link) return alert("Please paste a Google Sheets CSV link");

  localStorage.setItem("sheetLink", link);

  const res = await fetch(link);
  const text = await res.text();
  processCSVText(text);

  statusMsg.classList.remove("hidden");
  setTimeout(() => statusMsg.classList.add("hidden"), 2000);
});
</script>
</body>
</html>
